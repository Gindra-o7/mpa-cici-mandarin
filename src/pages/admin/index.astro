---
import Layout from "../../layouts/Layout.astro";

import { getArticles } from "../../utils/data";
import AdminAuthModal from "../../components/admin/AdminAuthModal.astro";

const articles = getArticles();
---

<Layout title="Admin Dashboard">
  <AdminAuthModal />
  <main class="min-h-screen bg-gray-50 pt-24 pb-12 md:py-32 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Article Dashboard</h1>

        <div class="flex gap-2">
          <button
            id="export-btn"
            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            Export Backup
          </button>
          <button
            id="import-btn-trigger"
            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            Import Backup
          </button>
          <input type="file" id="import-file" class="hidden" accept=".zip" />
          <a
            href="/admin/create"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-700 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
          >
            Create New Article
          </a>
        </div>
      </div>

      <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <ul role="list" class="divide-y divide-gray-200">
          {
            articles.length > 0 ? (
              articles.map((article: any) => (
                <li>
                  <div class="px-4 py-4 sm:px-6">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center">
                        {article.coverImage && <img class="h-12 w-16 object-cover rounded mr-4" src={article.coverImage} alt="" />}
                        <p class="text-sm font-medium text-red-600 truncate">{article.title}</p>
                      </div>
                      <div class="ml-2 shrink-0 flex">
                        <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">{article.topic}</p>
                      </div>
                    </div>
                    <div class="mt-2 sm:flex sm:justify-between">
                      <div class="sm:flex">
                        <p class="flex items-center text-sm text-gray-500">
                          <svg class="shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                          </svg>
                          {article.author}
                        </p>
                        <p class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0 sm:ml-6">
                          <svg class="shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                          </svg>
                          Published on {article.publishDate}
                        </p>
                      </div>
                      <div class="mt-2 flex items-center text-sm sm:mt-0 gap-3">
                        <a href={`/article/${article.slug}`} target="_blank" class="font-medium text-gray-600 hover:text-gray-500">
                          View
                        </a>
                        <span class="text-gray-300">|</span>
                        <a href={`/admin/edit/${article.slug}`} class="font-medium text-indigo-600 hover:text-indigo-500">
                          Edit
                        </a>
                        <span class="text-gray-300">|</span>
                        <button data-slug={article.slug} class="delete-btn font-medium text-red-600 hover:text-red-500">
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </li>
              ))
            ) : (
              <div class="p-8 text-center text-gray-500">No articles found. Create one to get started!</div>
            )
          }
        </ul>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Export Backup Logic
  const exportBtn = document.getElementById("export-btn");
  if (exportBtn) {
    exportBtn.addEventListener("click", () => {
      const adminCode = sessionStorage.getItem("admin_code");
      if (!adminCode) {
        alert("Session expired. Please reload the page to authenticate.");
        return;
      }
      window.location.href = `/api/backup-local?code=${adminCode}`;
    });
  }

  // Import Backup Logic
  const importBtnTrigger = document.getElementById("import-btn-trigger");
  const importFileInput = document.getElementById("import-file") as HTMLInputElement;

  if (importBtnTrigger && importFileInput) {
    importBtnTrigger.addEventListener("click", () => {
      importFileInput.click();
    });

    importFileInput.addEventListener("change", async (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;

      if (!confirm("Are you sure you want to restore this backup? This will overwrite existing data.")) {
        importFileInput.value = ""; // Reset
        return;
      }

      const adminCode = sessionStorage.getItem("admin_code");
      if (!adminCode) {
        alert("Session expired. Please reload the page to authenticate.");
        return;
      }

      const formData = new FormData();
      formData.append("backup", file);

      const originalText = importBtnTrigger.innerText;
      importBtnTrigger.innerText = "Restoring...";
      (importBtnTrigger as HTMLButtonElement).disabled = true;

      try {
        const response = await fetch("/api/restore-local", {
          method: "POST",
          headers: {
            "X-Admin-Code": adminCode,
          },
          body: formData,
        });

        const result = await response.json();

        if (response.ok && result.success) {
          alert("Backup restored successfully!");
          window.location.reload();
        } else {
          console.error(result);
          alert("Restore failed: " + (result.message || "Unknown error"));
        }
      } catch (error) {
        console.error("Restore error:", error);
        alert("An error occurred during restore.");
      } finally {
        importBtnTrigger.innerText = originalText;
        (importBtnTrigger as HTMLButtonElement).disabled = false;
        importFileInput.value = "";
      }
    });
  }

  const deleteBtns = document.querySelectorAll(".delete-btn");
  deleteBtns.forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      if (!confirm("Are you sure you want to delete this article? This action cannot be undone.")) return;

      const slug = (e.target as HTMLElement).dataset.slug;
      try {
        const res = await fetch(`/api/articles?slug=${slug}`, {
          method: "DELETE",
        });

        if (res.ok) {
          alert("Article deleted successfully");
          window.location.reload();
        } else {
          alert("Failed to delete article");
        }
      } catch (err) {
        console.error(err);
        alert("Error deleting article");
      }
    });
  });
</script>
